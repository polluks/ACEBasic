================================================================================
  ACE Compiler Makefile Migration Specification
================================================================================

Version: 1.0
Date: 2026-01-17
Target: GNU Make 3.80 (AmigaOS native)

================================================================================
KEY DECISIONS (Approved)
================================================================================

1. Makefile Location: ACE:make/Makefile-ace (alongside existing scripts)
2. Target Platform: AmigaOS native only (not cross-compilation)
3. Make Version: GNU Make 3.80 (available on Amiga)
4. Toolchain: gcc 2.95.3 (keep existing compiler)
5. Path Strategy: Keep ACE: assign dependency
6. Scope: ACE compiler only (libraries in future phases)
7. Features:
   - NO automatic dependency tracking
   - NO parallel builds
   - YES incremental builds (Make timestamp tracking)
   - YES clean targets
   - YES verbose/quiet modes (V=0/V=1 flag)
8. Directory Structure: Unchanged (src/ace/c, src/ace/obj, bin)
9. Error Handling: Make default (stop on first error)
10. Backup Strategy: Keep existing (separate 'make backup' target)
11. Version Control: All work in feature/makefile-migration branch

================================================================================
1. OBJECTIVES
================================================================================

Migrate ACE compiler build from AmigaDOS scripts (make/cmake, make/makeace)
to a GNU Makefile that provides:

  - Incremental builds (rebuild only changed sources)
  - Standard targets (all, clean, install)
  - Backward compatibility with existing ACE: assign structure
  - Verbose/quiet output modes
  - Drop-in replacement for existing workflow

Out of scope (for this phase):
  - Runtime libraries (db.lib, ami.lib) - separate future phase
  - Parallel builds (-j flag)
  - Automatic dependency tracking (.d files)
  - Cross-compilation support

================================================================================
2. CURRENT BUILD SYSTEM ANALYSIS
================================================================================

2.1 Current Scripts
-------------------

make/cmake <module>     - Compiles single C module to object file
make/makeace           - Compiles all 32 modules and links executable

2.2 Build Process
-----------------

For each module:
  cd ACE:src/ace/c
  gcc <module>.c -m68020 -c -s -O -pedantic -Wcast-qual -noixemul \
      -I. -o /ace/src/ace/obj/<module>.o
  cd ///make

For linking:
  cd ACE:src/ace/obj
  gcc -m68020 -s *.o -noixemul -o ace:bin/ace
  cd ///make

2.3 Source Modules (29 total - VERIFIED)
-----------------------------------------

Modules to compile (from makeace script):

alloc.c       assign.c      basfun.c      control.c
declare.c     event.c       expr.c        factor.c
file.c        gadget.c      gfx.c         iff.c
lex.c         libfunc.c     memory.c      menu.c
message.c     misc.c        opt.c         parse.c
parsevar.c    print.c       screen.c      serial.c
statement.c   sub.c         sym.c         ver.c
window.c

Files NOT compiled separately (included via #include):

lexvar.c      - Included in lex.c (lexical analyzer variables)
symvar.c      - Included in sym.c (symbol table variables)

Total .c files in src/ace/c/: 31
Files to compile and link: 29

2.4 Directory Structure
-----------------------

ACE:src/ace/c/         - Source files (.c)
ACE:src/ace/obj/       - Object files (.o)
ACE:bin/               - Executable (ace)
ACE:make/              - Build scripts (current location)

================================================================================
3. MAKEFILE DESIGN
================================================================================

3.1 Location
------------

Location: ACE:make/Makefile-ace (alongside existing build scripts)

Rationale:
  - Keeps all build-related files in one location
  - Specific naming allows future Makefiles for libraries (Makefile-db, etc.)
  - Easier transition - developers already use make/ directory
  - Can invoke as 'make -f make/Makefile-ace' from root if needed
  - Preserves existing organization structure

3.2 Structure
-------------

Makefile-ace
  ├─ Configuration variables (compiler, flags, paths)
  ├─ Source file list
  ├─ Automatic object file list (pattern substitution)
  ├─ Phony targets (.PHONY declarations)
  ├─ Default target (all)
  ├─ Executable target (bin/ace)
  ├─ Object file pattern rule (%.o: %.c)
  ├─ Utility targets (clean, backup)
  └─ Help target (help)

3.3 Core Variables
------------------

# Toolchain
CC = gcc
CFLAGS = -m68020 -c -s -O -pedantic -Wcast-qual -noixemul
LDFLAGS = -m68020 -s -noixemul
INCLUDES = -I.

# Paths (using ACE: assign)
SRC_DIR = ACE:src/ace/c
OBJ_DIR = ACE:src/ace/obj
BIN_DIR = ACE:bin
TARGET = $(BIN_DIR)/ace

# Verbose control
V = 0
ifeq ($(V),1)
  Q =
  ECHO = @true
else
  Q = @
  ECHO = @echo
endif

# Source files (29 modules - matches makeace script)
# Note: lexvar.c and symvar.c are NOT listed here because they are
#       included via #include in lex.c and sym.c respectively
SOURCES = alloc.c assign.c basfun.c control.c declare.c \
          event.c expr.c factor.c file.c gadget.c gfx.c \
          iff.c lex.c libfunc.c memory.c menu.c message.c \
          misc.c opt.c parse.c parsevar.c print.c screen.c \
          serial.c statement.c sub.c sym.c ver.c window.c

# Object files (pattern substitution)
OBJECTS = $(SOURCES:%.c=$(OBJ_DIR)/%.o)

3.4 Build Rules
---------------

# Default target
all: $(TARGET)

# Link executable
$(TARGET): $(OBJECTS)
	$(ECHO) "Linking ACE..."
	$(Q)cd $(OBJ_DIR) && $(CC) $(LDFLAGS) $(notdir $(OBJECTS)) -o $(TARGET)

# Compile source files
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	$(ECHO) "Compiling $<..."
	$(Q)cd $(SRC_DIR) && $(CC) $(CFLAGS) $(INCLUDES) $(notdir $<) -o $@

# Clean build artifacts
clean:
	$(ECHO) "Cleaning object files..."
	$(Q)delete $(OBJ_DIR)/#?.o QUIET
	$(ECHO) "Cleaning executable..."
	$(Q)delete $(TARGET) QUIET

# Backup current executable
backup:
	$(ECHO) "Backing up ace..."
	$(Q)copy $(TARGET) $(BIN_DIR)/ace.old CLONE QUIET

# Help text
help:
	@echo "ACE Compiler Makefile (Makefile-ace)"
	@echo ""
	@echo "Targets:"
	@echo "  all      - Build ACE compiler (default)"
	@echo "  clean    - Remove all object files and executable"
	@echo "  backup   - Backup current executable to ace.old"
	@echo "  help     - Show this help message"
	@echo ""
	@echo "Options:"
	@echo "  V=1      - Verbose output (show all commands)"
	@echo ""
	@echo "Examples:"
	@echo "  make -f Makefile-ace           # Build with quiet output"
	@echo "  make -f Makefile-ace V=1       # Build with verbose output"
	@echo "  make -f Makefile-ace clean all # Clean rebuild"

.PHONY: all clean backup help

3.5 Build Behavior
------------------

Error Handling:
  - Use Make's default error handling (stop on first error)
  - No -k (keep-going) flag by default
  - Failed compilation stops entire build immediately
  - Provides clear feedback on first failure

Backup Strategy:
  - Preserve existing backup workflow from cmake script
  - Separate 'backup' target (not automatic)
  - User explicitly calls 'make backup' before risky builds
  - Creates ace.old as safety copy using CLONE flag

AmigaDOS Command Compatibility:
  - delete command with QUIET flag (suppress errors)
  - copy command with CLONE and QUIET flags
  - All commands tested on AmigaOS environment

================================================================================
4. IMPLEMENTATION PLAN
================================================================================

4.1 Version Control Strategy
-----------------------------

All development work MUST be done in a separate git branch:

Branch name: feature/makefile-migration
Base branch: master

Workflow:
  1. Create feature branch from current master
     git checkout -b feature/makefile-migration

  2. Implement changes iteratively with focused commits
     - Each implementation step as separate commit
     - Clear commit messages describing changes

  3. Testing performed on feature branch

  4. When complete, create pull request for review
     - Allows review before merging to master
     - Can discuss and refine before integration
     - Easy to abandon/restart if needed

  5. Merge to master only after successful testing

Benefits:
  - Preserves working master branch during development
  - Easy rollback if issues discovered
  - Clear change history for review
  - Can continue other work on master if needed

4.2 Prerequisites
-----------------

[X] Verify all source files exist in src/ace/c/ (29 modules confirmed)
[ ] Create feature branch (feature/makefile-migration)
[ ] Verify GNU Make 3.80 features available on target Amiga
[ ] Verify gcc 2.95.3 command-line compatibility
[ ] Verify ACE: assign is properly configured

4.3 Implementation Steps
------------------------

Step 1: Create Makefile-ace skeleton
  - Add header comment and configuration section
  - Define all variables (CC, CFLAGS, paths)
  - Set up verbose/quiet mechanism

Step 2: Define source and object lists
  - List all 29 source files explicitly (verified against makeace)
  - Generate object file list via pattern substitution
  - Add comment explaining lexvar.c and symvar.c exclusion

Step 3: Implement build rules
  - Default 'all' target
  - Executable linking rule ($(TARGET))
  - Object compilation pattern rule (%.o: %.c)
  - Test incremental builds work correctly

Step 4: Add utility targets
  - clean (remove objects and executable)
  - backup (copy exe to ace.old)
  - help (usage information)

Step 5: Testing
  - Clean build (make clean all)
  - Incremental build (touch one file, make)
  - Verify executable works (bin/ace --version or similar)
  - Verbose mode (make V=1)

Step 6: Documentation
  - Update CLAUDE.md with Makefile-ace instructions
  - Add comment header to Makefile-ace
  - Document variable overrides and -f flag usage

4.4 Testing Checklist
---------------------

All commands run from make/ directory or use -f flag:

[ ] make -f Makefile-ace (builds all from scratch)
[ ] make -f Makefile-ace (second run - should skip if nothing changed)
[ ] touch src/ace/c/lex.c && make -f Makefile-ace (rebuild only lex.o and relink)
[ ] make -f Makefile-ace clean (removes all artifacts)
[ ] make -f Makefile-ace V=1 (shows full commands)
[ ] make -f Makefile-ace backup (creates ace.old)
[ ] make -f Makefile-ace help (displays help text)
[ ] Verify bin/ace executable works correctly

================================================================================
5. COMPATIBILITY CONSIDERATIONS
================================================================================

5.1 AmigaOS Path Handling
--------------------------

- Use ACE: assign (works in Make variables)
- Avoid Unix-style / separators where possible
- Use $(notdir) to strip paths when needed
- cd to correct directory before gcc invocation

5.2 Command Compatibility
--------------------------

GNU Make 3.80 on AmigaOS:
  - Pattern rules (%.o: %.c) - SUPPORTED
  - Substitution references ($(VAR:.c=.o)) - SUPPORTED
  - Conditional expressions (ifeq) - SUPPORTED
  - Functions (notdir, wildcard) - SUPPORTED
  - .PHONY target - SUPPORTED

AmigaDOS commands in recipes:
  - delete instead of rm
  - copy instead of cp
  - Use QUIET flag to suppress output

5.3 Shell Differences
---------------------

Make uses Amiga shell for recipe execution:
  - No bash-isms (&&, ||, $())
  - Use semicolons for command separation
  - CD changes persist within recipe line only

================================================================================
6. FUTURE ENHANCEMENTS (Post-Phase-1)
================================================================================

Phase 2: Runtime Library db.lib
  - Create Makefile-db (or Makefile-lib)
  - C and assembly source handling
  - join command for library creation

Phase 3: Startup Library
  - Create Makefile-startup
  - Simple assembly to library rule

Phase 4: Unified Build
  - Top-level Makefile in make/ directory
  - Calls Makefile-ace, Makefile-db, Makefile-startup
  - Single 'make -f Makefile' builds compiler + libraries

Phase 5: Advanced Features
  - Automatic dependency tracking (.d files)
  - Parallel builds (test with -j flag)
  - Cross-compilation support

================================================================================
7. RISKS AND MITIGATIONS
================================================================================

Risk: Path handling differences between AmigaOS and Make
Mitigation: Test all path operations, use cd + relative paths

Risk: GNU Make 3.80 feature differences from modern Make
Mitigation: Stick to well-documented POSIX features, test on target

Risk: Breaking existing workflow for users
Mitigation: Keep AmigaDOS scripts alongside Makefile-ace initially

Risk: Object file staleness not detected
Mitigation: Make tracks timestamps - standard behavior

Risk: Incomplete source file list
Mitigation: Cross-reference with makeace, test compile all modules

================================================================================
8. OPEN QUESTIONS
================================================================================

Q1: Should we support building from directories other than ACE:?
A1: Not for phase 1 - keep ACE: assign dependency

Q2: Should 'make install' copy executable somewhere?
A2: Defer - ace already builds to bin/, no separate install needed

Q3: Should we version-control the Makefile in make/ or root?
A3: make/ directory (ACE:make/Makefile-ace) - keeps build files together

Q6: Why Makefile-ace instead of just Makefile?
A6: Specific naming allows future library Makefiles (Makefile-db for db.lib,
    Makefile-startup for startup.lib) without conflicts

Q4: Should we preserve cmake script for individual module builds?
A4: Yes initially - deprecate later once Makefile proven stable

Q5: How to handle the symvar.c and winfunc.c modules?
A5: Need to verify these exist and add to SOURCES list

================================================================================
9. SUCCESS CRITERIA
================================================================================

The migration is successful when:

  [1] make -f Makefile-ace builds bin/ace from clean state
  [2] make -f Makefile-ace (second run) correctly skips rebuild when no changes
  [3] Modifying one .c file rebuilds only that .o and relinks
  [4] make -f Makefile-ace clean removes all build artifacts
  [5] Generated executable is identical to script-built version
  [6] Build time is comparable to script-based approach
  [7] Makefile-ace works on Amiga with GNU Make 3.80
  [8] Documentation updated with new build instructions

================================================================================
10. NEXT STEPS
================================================================================

After discussion and approval of this specification:

1. Create feature branch
   git checkout -b feature/makefile-migration

2. Source file list verified ✓
   - 29 modules confirmed (matches makeace script)
   - lexvar.c and symvar.c excluded (#included by other files)

3. Create initial Makefile-ace (ACE:make/Makefile-ace)
   - Add header and configuration
   - Define source list and variables
   - Implement basic build rules

4. Test basic compilation and linking
   - Clean build (make -f Makefile-ace clean all)
   - Incremental build (make -f Makefile-ace)

5. Iterate on verbose/quiet output modes (V=0/V=1)

6. Add utility targets (clean, backup, help)

7. Full testing against checklist (section 4.4)

8. Update CLAUDE.md documentation with Makefile-ace usage
   - Document -f flag usage
   - Show example commands

9. Commit changes with clear messages

10. Create pull request for review

11. After approval, merge to master

12. Consider deprecation timeline for AmigaDOS scripts

================================================================================
END OF SPECIFICATION
================================================================================
