Compiler Refactoring State
===========================

Last completed: Phase 3.4 - Break up statement()
  Branch: phase3.4-statement-breakup

Phase 1 (all 6 steps) - merged to master
  1.1: Consolidated frame_ptr[] from 11 static copies to one in misc.c + extern in acedef.h
  1.2: Extracted make_ext_name() in misc.c, replaced 6 occurrences
  1.3: Extracted make_modvar_bss_name() in misc.c, replaced 4 occurrences
  1.4: Extracted alloc_die() static helper in sym.c, replaced 18 blocks
  1.5: Extracted sym_to_type() in misc.c, replaced 9 switch blocks
  1.6: Changed structmem_exist() to return STRUCM*, replaced 2 manual loops

Phase 2 (codegen layer) - merged to master
  2.1: Created codegen.c with gen_rt_call(funcname) - wraps gen("jsr",...)+enter_XREF()
       - New file: src/ace/c/codegen.c
       - Prototype in acedef.h, added to Makefile-ace SOURCES
       - Replaced ~235 jsr+enter_XREF pairs across 20 source files
       - Files modified: declare.c, memory.c, misc.c, iff.c, window.c, screen.c,
         serial.c, menu.c, libfunc.c, message.c, event.c, gadget.c, print.c,
         gfx.c, assign.c, file.c, expr.c, factor.c, statement.c, basfun.c
       - LVO calls through (a6), indirect (a0), and dynamic name calls excluded
  2.2: Extracted gen_frame_addr(address, buf) into codegen.c
       - Wraps itoa(-1*address, buf, 10) + strcat(buf, frame_ptr[lev])
       - Added extern int lev to codegen.c, prototype in acedef.h
       - Replaced ~46 occurrences across 12 source files
       - Files modified: assign.c, statement.c, factor.c, sub.c, file.c,
         declare.c, misc.c, basfun.c, control.c, gfx.c, serial.c, message.c
       - Excluded: sub.c parse_shared_vars() hardcoded (a4)/(a5) for cross-level sharing

  2.3: Extracted gen_push/gen_pop/gen_move_typed into codegen.c
       - gen_push(type, src): move.w/l src, -(sp) based on shorttype
       - gen_pop(type, dest): move.w/l (sp)+, dest based on shorttype
       - gen_move_typed(type, src, dest): move.w/l src, dest based on shorttype
       - Replaced ~37 occurrences across 8 source files
       - Files modified: expr.c, factor.c, sub.c, assign.c, control.c,
         declare.c, statement.c, misc.c
       - Excluded: change_Flt (uses change()), extvar push (3-way with pea),
         FOR default step (singletype uses different value), FOR step add
         (move+add coupled), print.c/file.c (pop+type-specific call per case),
         assign extvar (3-way with string lea+strcpy), INVOKE closure
         bound-arg read (always move.l), INVOKE closure param copy with
         bound-arg truncation (extra truncation code)

  2.4: Extracted gen_coerce_slots(cx, count) into codegen.c
       - Generates NOP placeholders and fills cx[] array for type coercion
       - Replaced 13 for-loops: 10 in expr.c, 3 in control.c
       - Removed unused extern CODE *curr_code from expr.c
       - count=5 for expr operators (full coercion), count=3 for control flow (short->long only)

  2.5: Extracted gen_lib_call(func_item) into codegen.c
       - Wraps check_for_ace_lib + make_library_base + move.l base,a6
         + jsr offset(a6) + restore_a4/a5
       - Replaced 3 occurrences: statement.c (2x), factor.c (1x)
       - Removed unused externs (acelib, librarybase, restore_a4/a5) from statement.c, factor.c
       - Removed unused locals (libnum, func_address) from statement.c, factor.c

  2.6: Extracted gen_lib_open_check(open_func, ok_label) into codegen.c
       - Emits jsr open_func / cmpi #1,_starterr / bne ok_label / jmp _ABORT / label:
       - Uses fprintf(dest,...) since these are in the startup section (outside code list)
       - Replaced 7 blocks in parse.c compile(): translator, mathffp, mathtrans,
         intuition (2x), gfx, gadtools
       - Excluded: _startup block (uses rts instead of jmp _ABORT_PROG)

  2.7: Extracted gen_var_addr/gen_load_var/gen_store_var into codegen.c
       - gen_var_addr(item, buf): computes effective address for variable/array
         (handles module-level address==-32767 with BSS name vs frame-relative)
       - gen_load_var(item, srcbuf): pushes variable value, handles shared indirection
       - gen_store_var(item, addrbuf, src): stores value to variable, handles shared indirection
       - Replaced 2 address computation blocks: factor.c (1x), assign.c (1x)
       - Replaced 1 variable load block: factor.c (1x)
       - Replaced 10 variable store blocks: assign.c assign() (1x), assign.c input() (3x),
         assign.c read_data() (3x), file.c input_from_file() (3x)
       - Files modified: codegen.c, acedef.h, factor.c, assign.c, file.c
       - Removed unused extern module_opt from factor.c
       - Excluded: sub.c parse_shared_vars() (different semantics - stores address INTO frame)
       - Excluded: basfun.c VARPTR (returns address OF variable)
       - Excluded: input()/read_data()/input_from_file() address computation (bare gen_frame_addr)

Phase 3 (parser decomposition)
  3.1: Merged increment/decrement handlers in statement.c
       - Extracted static handle_inc_dec(is_increment) function
       - Replaces ~95 duplicated lines with 55-line shared function + 2 one-line calls
       - Parameterizes add/sub and SPAdd/SPSub based on BOOL flag
       - Removed unused inc_item/dec_item locals from statement()

  3.2: Extracted pointer dereference assignment in statement.c
       - Extracted static handle_pointer_assign(pointer_sym) function
       - Replaces ~68 duplicated lines (3 handlers for *%, *&, *!) with shared function + 3 one-line calls
       - Parameterizes move_instr (move.w/move.l) and coercion (make_sure_short/make_integer+make_long/gen_Flt)
       - Net savings: ~17 lines, eliminates structural duplication

  3.3: Extracted INVOKE handling into invoke.c
       - New file: src/ace/c/invoke.c with handle_invoke(invoke_item, wants_return)
       - Prototype in acedef.h, added to Makefile-ace SOURCES (30 modules)
       - Replaced ~280 lines in statement.c and ~310 lines in factor.c
       - Three dispatch paths: closure, SUB calling convention, unknown signature
       - wants_return flag controls whether return value is pushed onto stack
       - Removed unused locals from factor.c: invoke_sub, i, popcount
       - Net savings: ~280 lines

  3.4: Break up statement() into dispatcher with static handler functions
       - Extracted 16 static handler functions from statement()'s if/else-if chain
       - handle_ident_statement (~88 lines): ident sym - assignment, implicit call, or label
       - handle_call (~89 lines): callsym - CALL command (function, SUB, machine code, external)
       - handle_let (~26 lines): letsym - LET assignment
       - handle_assert (~18 lines): assertsym - ASSERT with optional message
       - handle_exit_statement (~28 lines): exitsym - EXIT FOR/SUB
       - handle_goto_gosub (~27 lines): gotosym/gosubsym - GOTO/GOSUB
       - handle_invoke_stmt (~15 lines): invokesym - INVOKE indirect call
       - handle_locate (~17 lines): locatesym - LOCATE row,col
       - handle_on (~10 lines): onsym - ON event/expression
       - handle_palette (~34 lines): palettesym - PALETTE color,r,g,b
       - handle_randomize (~10 lines): randomizesym - RANDOMIZE seed
       - handle_say (~31 lines): saysym - SAY phoneme string
       - handle_setxy (~16 lines): setxysym - SETXY x,y
       - handle_sleep (~23 lines): sleepsym - SLEEP / SLEEP FOR
       - handle_system (~19 lines): systemsym - SYSTEM returncode/command
       - handle_wave (~38 lines): wavesym - WAVE voice,definition
       - statement() locals reduced from 16 declarations to 1 (idholder[50])
       - statement() is now a clean dispatcher (~510 lines, down from ~973)
       - All new functions are static (no acedef.h changes needed)
       - Small inline blocks (<10 lines) kept inline for readability

Test suite: 178/178 pass

Next step: Phase 3.5 - TBD
