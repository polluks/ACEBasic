================================================================================
  ACE Compiler Makefile Migration - Step-by-Step Testing Plan
================================================================================

Version: 1.0
Date: 2026-01-18

================================================================================
OVERVIEW
================================================================================

This document provides a practical, step-by-step testing approach for verifying
the Makefile-ace migration. Tests progress from simple to complex, with each
phase building on the previous one.

Principle: ONE STEP AT A TIME - verify each step works before proceeding.

================================================================================
PERSONA
================================================================================

You are a test engineer that has great experience with AmigaOS, AmigaDOS, ARexx, etc.


================================================================================
AMIGA TEST ENVIRONMENT
================================================================================

Emulator Setup
--------------

Platform: fs-uae (FS-UAE.app)
Location: verify/scripts/otherthenamiga/FS-UAE.app/Contents/MacOS/fs-uae
Configuration: verify/scripts/otherthenamiga/ace-verify.fs-uae


================================================================================
CURRENT STATE
================================================================================

- Makefile-ace exists at: ACE:src/make/Makefile-ace
- fs-uae configured via: verify/scripts/otherthenamiga/ace-verify.fs-uae
- ACE: assign maps to project as hard_drive_1
- user-startup has ACE verification section (commented out)
- Test runner exists: verify/tests/runner.rexx

================================================================================
REQUIRED SETUP (user-startup)
================================================================================

The following must be configured in user-startup for ACE to work properly:

Stack Size
----------
stack 65000

ACE Assigns (from INSTALL file)
-------------------------------
assign ACElib: ACE:lib
assign ACEbmaps: ACE:bmaps
assign ACEinclude: ACE:include
path ACE:bin add

Test Runner Configuration
-------------------------
- runner.rexx must be run from ACE:verify/tests directory (uses relative paths)
- runner.rexx uses 'execute ACE:bin/bas' for full build pipeline
- The bas script requires app, a68k, blink in path (via ACE:bin)

================================================================================
PHASE 1: PRE-FLIGHT CHECKS (Host-Side - macOS)
================================================================================

Before launching fs-uae, verify setup from macOS host.
Script: verify/scripts/phase1-verify.sh

Test 1.1: Makefile Syntax Check
-------------------------------
Purpose: Verify Make can parse the Makefile (catches syntax errors)
Command: cd make && make -f Makefile-ace -n all 2>&1 | head -20
Note: AmigaDOS commands won't exist on host, but syntax errors are caught.

Test 1.2: Source File List Verification
---------------------------------------
Purpose: Verify all 29 source files exist
Command: ls -1 src/ace/c/*.c | wc -l
Expected: 31 files (29 compiled + 2 included: lexvar.c, symvar.c)

Test 1.3: Object Directory Exists
---------------------------------
Purpose: Verify obj directory exists for compiled output
Command: ls -d src/ace/obj/
Expected: Directory exists

Test 1.4: Bin Directory Exists
------------------------------
Purpose: Verify bin directory exists for executable
Command: ls -d bin/
Expected: Directory exists

Script Output:
  - Writes results to verify/scripts/results/phase1.log
  - Creates verify/scripts/results/phase1-complete.marker on success
  - Returns non-zero exit code if any check fails

Findings: See verify/scripts/results/phase1-findings.txt

================================================================================
PHASE 2: BASIC MAKEFILE OPERATION (In fs-uae)
================================================================================

Launch fs-uae and test basic Makefile targets.

Test 2.1: Help Target Works
---------------------------
Purpose: Verify Makefile loads and help displays
Command: cd ACE:src/make && make -f Makefile-ace help
Expected: Help text displays without errors

Test 2.2: Clean Target Works (Empty State)
------------------------------------------
Purpose: Verify clean target handles missing files gracefully
Command: cd ACE:src/make && make -f Makefile-ace clean
Expected: No errors (QUIET flag suppresses file-not-found)

Test 2.3: Single Module Compilation (Manual)
--------------------------------------------
Purpose: Verify gcc toolchain works before involving Make
Command:
  cd ACE:src/ace/c
  gcc ver.c -m68020 -c -s -O -pedantic -Wcast-qual -noixemul -I. -o ACE:src/ace/obj/ver.o
Expected: ver.o created without errors

Test 2.4: Make Path Resolution (Source Directory)
-------------------------------------------------
Purpose: Verify Make correctly resolves /src/ace/c paths
         GNU Make may not handle AmigaDOS paths correctly.
Command: make -f Makefile-ace -p | search SRC_DIR
Expected:
  - SRC_DIR shows /src/ace/c
  - /src/ace/c/ver.c is accessible via root-relative path

Test 2.5: Make Path Resolution (Object Directory)
-------------------------------------------------
Purpose: Verify Make correctly resolves /src/ace/obj paths
Command: Check OBJ_DIR in Make's database, verify directory accessible
Expected:
  - OBJ_DIR shows /src/ace/obj
  - Directory exists or can be created via root-relative path

Test 2.6: Make Can Invoke GCC
-----------------------------
Purpose: Verify Make can start a build and invoke gcc
         This is a quick sanity check before full build
Command: make -f Makefile-ace V=1 (run for 5 seconds, check results)
Expected:
  - Make starts and invokes gcc
  - At least one .o file is created in /src/ace/obj/

Test 2.7: Cross-Volume Path Test
--------------------------------
Purpose: Verify root-relative paths work from ACE: volume
         The paths /src, /bin use leading slash meaning
         'relative to root of current volume'
Command: list / QUICK (from ACE:src/make directory)
Expected:
  - Root (/) lists ACE: volume contents
  - src directory visible at root
  - This confirms Make runs with ACE: as current volume

Findings: See verify/scripts/results/phase2-findings.txt

================================================================================
PHASE 3: FULL BUILD VERIFICATION (In fs-uae)
================================================================================

Test complete build cycle.

Test 3.1: Clean Build
---------------------
Purpose: Verify full build from clean state
Commands:
  cd ACE:src/make
  make -f Makefile-ace clean
  make -f Makefile-ace
Expected:
  - All 29 modules compile
  - ACE:bin/ace created
  - No errors

Test 3.2: No-Op Build (Timestamp Test)
--------------------------------------
Purpose: Verify Make skips rebuild when nothing changed
Command: make -f Makefile-ace
Expected: Message like "nothing to be done" or "up to date"

Test 3.3: Incremental Build
---------------------------
Purpose: Verify only changed files rebuild
Commands:
  echo ; >>ACE:src/ace/c/ver.c
  make -f Makefile-ace
Expected: Only ver.o recompiles, then relinking occurs

Test 3.4: Verbose Mode
----------------------
Purpose: Verify V=1 shows full commands
Commands:
  make -f Makefile-ace clean
  make -f Makefile-ace V=1
Expected: Full gcc command lines visible

Findings: See verify/scripts/results/phase3-findings.txt

================================================================================
PHASE 4: MAKEFILE BUILD VERIFICATION (In fs-uae)
================================================================================

Verify Makefile-ace produces a working ACE compiler executable.

Test 4.1: Build with Makefile
-----------------------------
Purpose: Build ACE with Makefile-ace and verify it succeeds
Commands:
  cd ACE:src/make
  make -f Makefile-ace clean
  make -f Makefile-ace V=1
Expected:
  - All 29 modules compile without errors
  - ACE:bin/ace created successfully

Test 4.2: Executable Loads and Runs
-----------------------------------
Purpose: Verify the compiled executable can start without crashing
Commands:
  ACE:bin/ace
  (run with no arguments - should display usage/error but not crash)
Expected:
  - Executable loads successfully
  - Displays version or usage message
  - Returns non-crash exit code (not guru meditation / address error)

Test 4.3: Functional Verification
---------------------------------
Purpose: Verify Makefile-built executable can compile BASIC code
Commands:
  echo 'PRINT "Hello from ACE!"' >T:test.b
  ACE:bin/ace T:test.b
Expected:
  - Compiler prints version info
  - Compiles without errors
  - Generates T:test.s assembly file

Findings: See verify/scripts/results/phase4-findings.txt

================================================================================
PHASE 5: FUNCTIONAL VERIFICATION (In fs-uae)
================================================================================

Verify the compiled ACE compiler works correctly.

Test 5.1: Compile a Simple Program
----------------------------------
Purpose: Verify ace can compile BASIC code
Command: ACE:bin/ace ACE:verify/tests/cases/syntax/hello.b
Expected: Produces .s file without errors

Test 5.2: Run Full Test Suite
-----------------------------
Purpose: Verify all tests pass with Makefile-built compiler
Commands:
  cd ACE:verify/tests
  rx runner.rexx
Expected: All tests pass
Timeout: 2 minutes (with proper setup, all 35 tests complete quickly)

Findings: See verify/scripts/results/phase5.log

STATUS: COMPLETED (2026-01-18)
Results: TOTAL: Passed: 35, Failed: 0, Skipped: 0

================================================================================
PHASE 6: FULL AUTOMATED VERIFICATION (Host + fs-uae)
================================================================================

Run all previous phases as an automated end-to-end verification.
This phase chains phases 1-5 together for complete validation.

Test 6.1: Full Verification Pipeline
------------------------------------
Purpose: Run all phase scripts sequentially
Scripts:
  - verify/scripts/phase1-verify.sh (Host-side pre-flight checks - macOS)
  - verify/scripts/phase2-verify.script (Basic Makefile operation - Amiga)
  - verify/scripts/phase3-verify.script (Full build verification - Amiga)
  - verify/scripts/phase4-verify.script (Makefile build verification - Amiga)
  - verify/scripts/phase5-verify.script (Functional verification + test suite - Amiga)

Phase 1 runs on macOS before fs-uae launches.
Phases 2-5 run inside fs-uae via user-startup.
Each phase writes its results to verify/scripts/results/phaseN.log
and creates a marker file verify/scripts/results/phaseN-complete.marker.

Test 6.2: Run Full Automated Verification
-----------------------------------------
Command (from host): ./verify/scripts/run-auto-verify.sh --wait
What it does:
  1. Runs phase1-verify.sh (host-side pre-flight checks)
  2. Aborts if Phase 1 fails (no point launching emulator)
  3. Launches fs-uae with ace-verify.fs-uae configuration
  4. user-startup runs phase 2-5 scripts automatically
  5. Polls for completion markers (see below)
  6. Displays aggregated results
  7. Shuts down fs-uae on completion

Completion Detection:
  IMPORTANT: Poll for the completion marker file frequently (every 5 seconds).
  Do NOT use a long fixed timeout (like 10+ minutes) before checking.
  The script should loop: check marker -> sleep 5s -> check marker -> ...
  Exit when phase5-complete.marker exists, or if fs-uae process dies.

Expected:
  - Phase 1: Makefile syntax OK, all source files present, directories exist
  - Phase 2: Help target works, clean works, path resolution OK
  - Phase 3: Full clean build succeeds, incremental build works
  - Phase 4: Makefile builds working ACE executable
  - Phase 5: All 35 tests pass (Passed: 35, Failed: 0, Skipped: 0)

Test 6.3: user-startup Configuration
------------------------------------
Location: verify/scripts/otherthenamiga/aos3/S/user-startup
Purpose: Configure automatic phase execution on boot (phases 2-5)

The user-startup should contain:
  - Stack and ACE assigns (required for all phases)
  - Execute commands for each phase script in sequence
  - Each phase script handles its own logging and marker creation

Findings: See verify/scripts/results/phase6-findings.txt

Results: All phases should produce logs and completion markers:
  - verify/scripts/results/phase1.log + phase1-complete.marker (host)
  - verify/scripts/results/phase2.log + phase2-complete.marker (Amiga)
  - verify/scripts/results/phase3.log + phase3-complete.marker (Amiga)
  - verify/scripts/results/phase4.log + phase4-complete.marker (Amiga)
  - verify/scripts/results/phase5.log + phase5-complete.marker (Amiga)

================================================================================
RUNNING PHASES INDIVIDUALLY
================================================================================

Phases can be run individually for debugging or incremental verification.

Phase 1 (macOS Host)
--------------------
Run directly from terminal:
  ./verify/scripts/phase1-verify.sh

Phases 2-5 (Amiga)
------------------
Option A: Manual execution from Amiga shell
  execute ACE:verify/scripts/phase2-verify.script
  execute ACE:verify/scripts/phase3-verify.script
  execute ACE:verify/scripts/phase4-verify.script
  execute ACE:verify/scripts/phase5-verify.script

Option B: Automated via user-startup
  Edit: verify/scripts/otherthenamiga/aos3/S/user-startup
  Uncomment/comment the execute lines for desired phases.

  Example - run only Phase 5:
    ; execute ACE:verify/scripts/phase2-verify.script
    ; execute ACE:verify/scripts/phase3-verify.script
    ; execute ACE:verify/scripts/phase4-verify.script
    execute ACE:verify/scripts/phase5-verify.script

Phase Scripts Reference
-----------------------
| Phase | Environment | Script                                  |
|-------|-------------|-----------------------------------------|
| 1     | macOS       | verify/scripts/phase1-verify.sh         |
| 2     | Amiga       | verify/scripts/phase2-verify.script     |
| 3     | Amiga       | verify/scripts/phase3-verify.script     |
| 4     | Amiga       | verify/scripts/phase4-verify.script     |
| 5     | Amiga       | verify/scripts/phase5-verify.script     |

================================================================================
TESTING ORDER SUMMARY
================================================================================

| Step | Test                      | Complexity | Est. Time  |
|------|---------------------------|------------|------------|
| 1.1  | Makefile syntax check     | Trivial    | 1 min      |
| 1.2  | Source file count         | Trivial    | 1 min      |
| 1.3  | Object directory exists   | Trivial    | 1 min      |
| 1.4  | Bin directory exists      | Trivial    | 1 min      |
| 2.1  | Help target               | Low        | 1 min      |
| 2.2  | Clean target (empty)      | Low        | 1 min      |
| 2.3  | Single gcc command        | Low        | 2 min      |
| 2.4  | Path resolution (src)     | Medium     | 1 min      |
| 2.5  | Path resolution (obj)     | Medium     | 1 min      |
| 2.6  | Pattern rule expansion    | Medium     | 1 min      |
| 2.7  | Cross-volume paths        | Medium     | 1 min      |
| 3.1  | Full clean build          | Medium     | 5-10 min   |
| 3.2  | No-op build               | Low        | 1 min      |
| 3.3  | Incremental build         | Medium     | 2 min      |
| 3.4  | Verbose mode              | Low        | 5 min      |
| 4.1  | Makefile build            | Medium     | 5-10 min   |
| 5.1  | Compile simple program    | Low        | 2 min      |
| 5.2  | Full test suite           | High       | 2 min      |
| 6.1  | Full verification pipeline| High       | 15-20 min  |
| 6.2  | Run full auto verification| High       | 15-20 min  |
| 6.3  | user-startup configuration| Low        | 5 min      |

================================================================================
FINDINGS FILE FORMAT
================================================================================

Each phase findings file should follow this format:

  ============================================================
  Phase N Findings - [Date]
  ============================================================

  Test N.1: [Test Name]
  ---------------------
  Status: PASS / FAIL / SKIP
  Command: [actual command run]
  Output: [relevant output]
  Notes: [any observations]

  Test N.2: [Test Name]
  ---------------------
  ...

  ============================================================
  Phase Summary
  ============================================================
  Tests Passed: X
  Tests Failed: X
  Tests Skipped: X

  Issues Found:
  - [issue 1]
  - [issue 2]

  Next Steps:
  - [action item 1]
  - [action item 2]

================================================================================
END OF TESTING PLAN
================================================================================
