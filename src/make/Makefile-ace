################################################################################
# ACE Compiler Makefile
################################################################################
#
# Description:
#   GNU Makefile for building the ACE (Amiga BASIC Compiler) executable.
#   Provides incremental builds, standard targets, and backward compatibility
#   with the existing ACE: assign structure.
#
# Location:
#   ACE:src/make/Makefile-ace
#
# Usage:
#   From src/make/ directory:
#     make -f Makefile-ace           # Build ACE compiler (quiet mode)
#     make -f Makefile-ace V=1       # Build with verbose output
#     make -f Makefile-ace clean     # Remove all build artifacts
#     make -f Makefile-ace backup    # Backup current executable
#     make -f Makefile-ace help      # Show help
#
#   From root directory:
#     make -f src/make/Makefile-ace
#
# Requirements:
#   - GNU Make 3.80 or later (AmigaOS)
#   - gcc 2.95.3
#   - ACE: assign must be configured
#	- UnixDirsII package
#
# Author: Generated from Makefile-Migration-Spec.txt
# Date: 2026-01-17
#
################################################################################

################################################################################
# CONFIGURATION
################################################################################

# Shell - use AmigaDOS shell instead of /bin/sh
SHELL = sh

# Toolchain
CC = gcc
CFLAGS = -m68020 -c -s -O -pedantic -Wcast-qual -noixemul
LDFLAGS = -m68020 -s -noixemul
INCLUDES = -I.

# Paths - Using relative paths from src/make/ directory
# Pattern rules require relative paths for Make to find source files correctly
# The ../ prefix works when running from ACE:src/make/
SRC_DIR = ../ace/c
OBJ_DIR = ../ace/obj
BIN_DIR = ../../bin
TARGET_NAME = ace
TARGET = $(BIN_DIR)/$(TARGET_NAME)

# Note: VPATH doesn't work reliably on AmigaOS, so we use explicit paths
# in the pattern rule instead

# Verbose control
# V=0 (default): Quiet mode - shows only high-level progress
# V=1: Verbose mode - shows all commands
V = 0
ifeq ($(V),1)
  Q =
  ECHO = @true
else
  Q = @
  ECHO = @echo
endif

################################################################################
# SOURCE FILES
################################################################################

# Source files (29 modules - verified against makeace script)
#
# Note: The following files are NOT listed here because they are included
#       via #include directives in other source files:
#         - lexvar.c  (included in lex.c)
#         - symvar.c  (included in sym.c)
SOURCES = alloc.c assign.c basfun.c codegen.c control.c declare.c \
          event.c expr.c factor.c file.c gadget.c gfx.c \
          iff.c lex.c libfunc.c memory.c menu.c message.c \
          misc.c opt.c parse.c parsevar.c print.c screen.c \
          serial.c statement.c sub.c sym.c ver.c window.c

# Object files (pattern substitution from source list)
OBJECTS = $(patsubst %.c,$(OBJ_DIR)/%.o,$(SOURCES))

################################################################################
# PHONY TARGETS
################################################################################

.PHONY: all clean backup help dirs

# Prevent parallel builds which can cause issues on AmigaOS
.NOTPARALLEL:

################################################################################
# BUILD TARGETS
################################################################################

# Default target
all: dirs $(TARGET)
	@echo "Build complete: $(TARGET)"

# Link executable from object files
$(TARGET): $(OBJECTS) | $(BIN_DIR)
	$(ECHO) "Linking ACE..."
	$(Q)$(CC) $(LDFLAGS) $(OBJECTS) -o $@

# Ensure directories exist before building
# Using mkdir -p (Unix style, works with ADE's sh shell)
.PHONY: dirs
dirs:
	-@mkdir -p $(OBJ_DIR)
	-@mkdir -p $(BIN_DIR)

# Ensure directories exist (order-only prerequisites)
$(OBJECTS): | $(OBJ_DIR)

$(OBJ_DIR):
	-@mkdir -p $(OBJ_DIR)

$(BIN_DIR):
	-@mkdir -p $(BIN_DIR)

# Compile source files to object files
# Using explicit source path since VPATH doesn't work reliably on AmigaOS
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	$(ECHO) "Compiling $<..."
	$(Q)$(CC) $(CFLAGS) -I$(SRC_DIR) $< -o $@

################################################################################
# UTILITY TARGETS
################################################################################

# Clean build artifacts
# Using rm -f for Unix-style deletion (works with ADE's sh shell)
# The wildcard *.o works in sh, unlike AmigaDOS #?.o
clean:
	$(ECHO) "Cleaning object files..."
	-$(Q)rm -f $(OBJ_DIR)/*.o
	$(ECHO) "Cleaning executable..."
	-$(Q)rm -f $(TARGET)
	@echo "Clean complete"

# Backup current executable
backup:
	$(ECHO) "Backing up ace..."
	$(Q)cp $(TARGET) $(BIN_DIR)/ace.old

# Help text
help:
	@echo "ACE Compiler Makefile (Makefile-ace)"
	@echo ""
	@echo "Targets:"
	@echo "  all      - Build ACE compiler (default)"
	@echo "  clean    - Remove all object files and executable"
	@echo "  backup   - Backup current executable to ace.old"
	@echo "  help     - Show this help message"
	@echo ""
	@echo "Options:"
	@echo "  V=1      - Verbose output (show all commands)"
	@echo ""
	@echo "Examples:"
	@echo "  make -f Makefile-ace           # Build with quiet output"
	@echo "  make -f Makefile-ace V=1       # Build with verbose output"
	@echo "  make -f Makefile-ace clean all # Clean rebuild"
