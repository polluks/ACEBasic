.KEY LOG/K
.BRA {
.KET }

; FFP Fix Verification Script - Test single-precision float printing
; Run from within AmigaOS (fs-uae)
;
; This tests the FFP/vbcc compatibility fix by compiling and running
; a program that prints a float value (1.1)
;
; Usage: execute ACE:verify/scripts/ffp-test.script

; Set default log location
IF "{LOG}" EQ ""
   SET LOGFILE "ACE:verify/scripts/results/ffp-test.log"
ELSE
   SET LOGFILE "{LOG}"
ENDIF

echo "" >$LOGFILE
echo "============================================================" >>$LOGFILE
echo "FFP Fix Verification - `date`" >>$LOGFILE
echo "============================================================" >>$LOGFILE
echo "" >>$LOGFILE
echo "Testing FFP/vbcc compatibility fix for float printing." >>$LOGFILE
echo "" >>$LOGFILE

; ------------------------------------------------------------------
; Test: Compile and Run SimpleHelloFloat.b
; ------------------------------------------------------------------
echo "============================================================" >>$LOGFILE
echo "Test: Compile and Run SimpleHelloFloat.b" >>$LOGFILE
echo "------------------------------------------------------------" >>$LOGFILE
echo "" >>$LOGFILE

SET TESTDIR "ACE:examples"
SET TESTPROG "SimpleHelloFloat"

echo "Source: $TESTDIR/$TESTPROG.b" >>$LOGFILE
echo "" >>$LOGFILE

; Verify source file exists
IF NOT EXISTS $TESTDIR/$TESTPROG.b
   echo "Status: FAIL" >>$LOGFILE
   echo "Source file $TESTDIR/$TESTPROG.b not found!" >>$LOGFILE
   SKIP ENDSCRIPT
ENDIF

echo "Source content:" >>$LOGFILE
type $TESTDIR/$TESTPROG.b >>$LOGFILE
echo "" >>$LOGFILE

; Change to test directory
cd $TESTDIR

; Remove any previous executable
IF EXISTS $TESTPROG
   delete $TESTPROG QUIET
ENDIF

; Run compilation steps manually for debugging
FAILAT 30

; Step 1: Preprocess
echo "Step 1: Preprocessing with app..." >>$LOGFILE
app $TESTPROG.b ram:t/$TESTPROG.b >T:ffp-step1.out *>T:ffp-step1.err
SET STEP1RC $RC
echo "  app exit code: $STEP1RC" >>$LOGFILE
IF EXISTS T:ffp-step1.out
   type T:ffp-step1.out >>$LOGFILE
ENDIF
IF EXISTS T:ffp-step1.err
   type T:ffp-step1.err >>$LOGFILE
ENDIF
echo "" >>$LOGFILE

IF $STEP1RC GT 10
   echo "  FAILED at preprocessing step" >>$LOGFILE
   SKIP COMPILEFAIL
ENDIF

; Check preprocessed file exists
IF NOT EXISTS ram:t/$TESTPROG.b
   echo "  FAILED: Preprocessed file not created" >>$LOGFILE
   SKIP COMPILEFAIL
ENDIF
echo "  Preprocessed file created: ram:t/$TESTPROG.b" >>$LOGFILE
echo "" >>$LOGFILE

; Step 2: Compile to assembly
echo "Step 2: Compiling with ace..." >>$LOGFILE
ace ram:t/$TESTPROG.b >T:ffp-step2.out *>T:ffp-step2.err
SET STEP2RC $RC
echo "  ace exit code: $STEP2RC" >>$LOGFILE
IF EXISTS T:ffp-step2.out
   type T:ffp-step2.out >>$LOGFILE
ENDIF
IF EXISTS T:ffp-step2.err
   type T:ffp-step2.err >>$LOGFILE
ENDIF
echo "" >>$LOGFILE

IF $STEP2RC GT 10
   echo "  FAILED at compilation step" >>$LOGFILE
   SKIP COMPILEFAIL
ENDIF

; Check assembly file exists
IF NOT EXISTS ram:t/$TESTPROG.s
   echo "  FAILED: Assembly file not created" >>$LOGFILE
   SKIP COMPILEFAIL
ENDIF
echo "  Assembly file created: ram:t/$TESTPROG.s" >>$LOGFILE
echo "" >>$LOGFILE

; Step 3: Assemble
echo "Step 3: Assembling with vasm..." >>$LOGFILE
vasmm68k_mot -Fhunk -o ram:t/$TESTPROG.o ram:t/$TESTPROG.s >T:ffp-step3.out *>T:ffp-step3.err
SET STEP3RC $RC
echo "  vasm exit code: $STEP3RC" >>$LOGFILE
IF EXISTS T:ffp-step3.out
   type T:ffp-step3.out >>$LOGFILE
ENDIF
IF EXISTS T:ffp-step3.err
   type T:ffp-step3.err >>$LOGFILE
ENDIF
echo "" >>$LOGFILE

IF $STEP3RC GT 0
   echo "  FAILED at assembly step" >>$LOGFILE
   SKIP COMPILEFAIL
ENDIF

; Check object file exists
IF NOT EXISTS ram:t/$TESTPROG.o
   echo "  FAILED: Object file not created" >>$LOGFILE
   SKIP COMPILEFAIL
ENDIF
echo "  Object file created: ram:t/$TESTPROG.o" >>$LOGFILE
echo "" >>$LOGFILE

; Step 4: Link
echo "Step 4: Linking with vlink..." >>$LOGFILE
vlink -bamigahunk -x -Bstatic -Cgnu -nostdlib -mrel -s -o ram:t/$TESTPROG ram:t/$TESTPROG.o ACElib:startup.lib ACElib:db.lib ACElib:ami.lib >T:ffp-step4.out *>T:ffp-step4.err
SET STEP4RC $RC
echo "  vlink exit code: $STEP4RC" >>$LOGFILE
IF EXISTS T:ffp-step4.out
   type T:ffp-step4.out >>$LOGFILE
ENDIF
IF EXISTS T:ffp-step4.err
   type T:ffp-step4.err >>$LOGFILE
ENDIF
echo "" >>$LOGFILE

IF $STEP4RC GT 0
   echo "  FAILED at linking step" >>$LOGFILE
   SKIP COMPILEFAIL
ENDIF

; Copy executable to current directory
IF EXISTS ram:t/$TESTPROG
   echo "  Executable created in ram:t, copying..." >>$LOGFILE
   copy ram:t/$TESTPROG $TESTPROG
ENDIF

; Clean up temp files
delete ram:t/$TESTPROG#? QUIET

LAB COMPILEFAIL

FAILAT 21

SET COMPRESULT $STEP4RC
IF $STEP1RC GT 10
   SET COMPRESULT $STEP1RC
ENDIF
IF $STEP2RC GT 10
   SET COMPRESULT $STEP2RC
ENDIF
IF $STEP3RC GT 10
   SET COMPRESULT $STEP3RC
ENDIF

echo "Overall compile result: $COMPRESULT" >>$LOGFILE
echo "" >>$LOGFILE

IF $COMPRESULT GT 10
   echo "Status: FAIL" >>$LOGFILE
   echo "Compilation returned error code: $COMPRESULT" >>$LOGFILE
   echo "" >>$LOGFILE
ENDIF

; Check executable was created
IF NOT EXISTS $TESTPROG
   echo "Status: FAIL - Executable not created" >>$LOGFILE
   SKIP ENDSCRIPT
ENDIF

echo "Executable created: $TESTPROG" >>$LOGFILE
list $TESTPROG >>$LOGFILE
echo "" >>$LOGFILE

; ------------------------------------------------------------------
; Execute and Verify Output
; ------------------------------------------------------------------
echo "============================================================" >>$LOGFILE
echo "Executing program..." >>$LOGFILE
echo "------------------------------------------------------------" >>$LOGFILE
echo "" >>$LOGFILE

$TESTPROG >T:ffp-output.out
SET RUNRESULT $RC

echo "Run exit code: $RUNRESULT" >>$LOGFILE
echo "" >>$LOGFILE
echo "Program output:" >>$LOGFILE
IF EXISTS T:ffp-output.out
   type T:ffp-output.out >>$LOGFILE
ELSE
   echo "(no output)" >>$LOGFILE
ENDIF
echo "" >>$LOGFILE

; ------------------------------------------------------------------
; Verify: Output should contain "1.1"
; ------------------------------------------------------------------
echo "============================================================" >>$LOGFILE
echo "Verifying output contains '1.1'..." >>$LOGFILE
echo "------------------------------------------------------------" >>$LOGFILE
echo "" >>$LOGFILE

search T:ffp-output.out "1.1" >T:ffp-search.out QUIET
IF WARN
   echo "*** FAIL: Output does not contain '1.1' ***" >>$LOGFILE
   echo "" >>$LOGFILE
   echo "Expected: ' 1.1' (with leading space for positive numbers)" >>$LOGFILE
   echo "Got:" >>$LOGFILE
   type T:ffp-output.out >>$LOGFILE
   echo "" >>$LOGFILE
   echo "FFP FIX MAY NOT BE WORKING CORRECTLY" >>$LOGFILE
ELSE
   echo "*** PASS: Output contains '1.1' ***" >>$LOGFILE
   echo "" >>$LOGFILE
   echo "FFP fix is working correctly!" >>$LOGFILE
ENDIF
echo "" >>$LOGFILE

; ------------------------------------------------------------------
; Summary
; ------------------------------------------------------------------
LAB ENDSCRIPT
echo "============================================================" >>$LOGFILE
echo "END OF FFP FIX VERIFICATION" >>$LOGFILE
echo "============================================================" >>$LOGFILE

; Clean up temp files
delete T:ffp-step1.out QUIET
delete T:ffp-step1.err QUIET
delete T:ffp-step2.out QUIET
delete T:ffp-step2.err QUIET
delete T:ffp-step3.out QUIET
delete T:ffp-step3.err QUIET
delete T:ffp-step4.out QUIET
delete T:ffp-step4.err QUIET
delete T:ffp-output.out QUIET
delete T:ffp-search.out QUIET

; Show results on screen
echo ""
echo "FFP Fix verification complete!"
echo "Results saved to: $LOGFILE"
echo ""
echo "Summary:"
type $LOGFILE

; Create completion marker
echo "FFP test complete" >ACE:verify/scripts/results/ffp-test-complete.marker
